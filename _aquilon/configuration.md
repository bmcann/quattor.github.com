---
layout: article
title: Starting a Site with Aquilon
author: Luis Fernando Muñoz Mejías
menu: Using Aquilon
redirect_from: /documentation/2013/10/25/aquilon-site.html
---

{% include link_definitions.md %}

This page documents how to configure a site with Aquilon, once the Aquilon broker is running,
i.e. how to describe the hardware present in the site and how to configure hosts and services.
For Aquilon installation, refer to the [dedicate page][aquilon_install]

This document explains the steps required to set up the clusters
for the Daily Planet, Superman's employer. Feel free to replace the names used here by those
relevant to your organization but be sure to remain consistant.

*Note: this documentation assumes that you have an `aq` command available in your
path. If this is not the case, define an `aq` alias to `/opt/aquilon/bin/aq.py`.*


## Aquilon terminology

These are the basic terms in Aquilon operations:

* `archetype`: The highest possible grouping of hosts into distinctly
    seperate types. Archetypes are a bundle
    that expresses how to build something. It defines what set of
    templates to use (for example, what operating systems are
    available, etc). Hosts therefore require an archetype to define
    how they are compiled.
* `broker`: The backend which the aq client communicates with and the
    owner of all object and production templates.  We'll refer to it
    also as `aqd`.
* `cluster`: A group of hosts related in some way, different to an
    archetype in that hosts may or may not be in a cluster. When
    grouping hosts into a cluster, an object profile is also built for
    the cluster, as well as the hosts. Clusters go through a
    completely different schema and build process to how hosts are
    built and therefore have a different archetypes.
* `domain`: A set of shared Quattor templates. Entities to be
  configured live in exactly one domain. A domain is currently
  implemented as a branch in the template-king git repository.
* `feature`: A re-useable configuration template that configures a
  specific thing but does not in itself describe a complete
  system. A feature may be included in
  a personality or anywhere else that PAN template code can be
  included.
* `personality`: describes the
  services required but not the instance (selected using plenary
  template information) specific configuration (hardware used, OS version...).
* `plenary`: Template generated by the broker, on the fly, from an
  external source such as the Aquilon database.
* `sandbox`: A development area for making changes to Pan
  templates. Each sandbox must be started from a domain and hosts or
  clusters may be managed into the sandbox to allow for pre-deployment
  testing. Once the template code is fully tested, it must be
  published back to the broker and then deployhttp://quattor-pan.readthedocs.org/en/latested to the shared domain.
* `service`: A network-based service with well-known clients and
  servers such as DNS, DHCP, NTP, etc. Each service can have multiple
  instances. Service instances must be mapped which allows the
  administrator to model client hosts connecting to different
  instances based on location and optionally personality.

For more details on these concepts, see the the [dedicated page][aquilon_details].

### Before proceeding

Some understanding of Quattor's [architecture](/documentation/2012/06/19/documentation-overview.html) and the
[Pan language][pan_language] are expected before reading this document.

We'll interact with the broker using the `aq` command, which has lots
of sub-commands.  Each sub-command has a detailed help. `aq` subcommands are generally
made of several words that can be separated either by a space or an `_`. The latter (`_`)
is preferred as it allows to use tab completion when entering command. This is the form
used throughout this document. In `aq`, everything before the first `option` (introduced
by `--`) is considered as a subcommand word. Options can be abbreviated as long as they
are non ambiguous but subcommand words cannot.

In this stage we will be adding a site, so we will use `add_*`
commands.  Most of the Aquilon commands have a `show_`, `update_`, `search_` and
`del_` counterparts.  `search_` commands are similar to `show_` commands but provide more
options to select the objects to show. You are recommended to read the help of each
command before actually running it.

Before starting using the `aq` command, you need get a Kerberos ticket. Use the `kinit` command
to get it. If the Kerberos principal to use is different from the current Linux user, pass its name
as a parameter to the `kinit` command.

## Domain and archetypes

### Domains

[Domains][aquilon_domains] allow to implement a staged deployment workflow. In our example,
we will use two domains:

* `test`: used for for testing configuration changes before wide deployment

    ```bash
    aq add_domain --domain 'test'
    ```

* `prod`: used for managing all the production services. During the [initialization][aquilon_install]
of Aquilon database, the `prod` domain was created in the database but the matching directory was not.
Below are the command to fix this:

    ```bash
    # Replace the directory by what is used at your site
    cd /var/quattor/domains
    cp -R test prod
    cd prod
    git checkout prod
    git branch -d test
    ```

### Archetypes

[Archetypes][aquilon_archetypes] are used to group hosts with common configuration parameters/requirements
(e.g. all your network switches) or with similar purposes (e.g. all your cloud hosts). In our example, we
will start with one archetype, `web_servers`.

```bash
aq add_archetype --archetype web_servers --compilable
```


## Storing your inventory

The Aquilon database contains the entire inventory of your
infrastructure.  You may use it as your asset management database, or
feed it from your existing one.  You will have to store all your
hardware, its characteristics and locations, which is easy to script
but nevertheless may be an annoying process.

### Geographical locations

Before starting, you have to add the geographical locations of your
infrastructure.  The meanings of the commands to run should be
obvious.  We list here an example:

```bash
aq add_organization --organization 'daily_planet'
aq add_hub --hub 'pacific' --organization 'daily_planet'
aq add_continent --continent 'america' --hub 'pacific'
aq add_country --country 'us' --continent 'america'
aq add_city --city 'metropolis' --fullname 'Metropolis' --country 'us' --timezone 'dct'
aq add_building --building 'hq' --city 'metropolis' --address '355, 1000 Broadway'
aq add_room --room 'supersecret' --building 'hq'
```

List your own addresses, rooms...  but remember that each step depends
on the previous ones.  If you want to add European countries, you have
to insert Europe as a continent first! Also note that object names
should not start with a digit and cannot contain spaces.

### Your hardware inventory

Next comes your hardware.  At the very least, your racks, chassis and
servers will be stored here.  It is a good place to store other
hardware such as switches.

For racks, you have to specify on which row and column inside that
row they are, the room they are located into and an optional fullname. A rack ID
will be allocated automatically with a prefix who is the building name and a sequential
number in this building.

```bash
aq add_rack --fullname 'forlexluthor' --row 'R' --column 'C' --room 'supersecret'
```

Next come servers, switches, routers... we'll go for servers,
`machine` in Aquilon terms.  To be able to define a server, we need to first define its
vendor and its CPU model. Initial Aquilon database already has several vendors and models
defines: use `aq show_vendor --all` and `aq show_model --all` to see them.

Here we'll use a simple rackmounted server but Aquilon allows to
also define other types of servers, in particular chassis and blades, and to
use them to build a machine. See `aq help add_model`.

```bash
aq add_vendor --vendor luthorindustries --comments "Bad guys make good sells"
aq add_model --model mygreatcpu --vendor intel --type cpu
aq add_model --model spyserver --vendor luthorindustries --type rackmount --cpuname mygreatcpu \
             --cpunum 2 --memory 98304 --disktype local --diskcontroller sas --disksize 1000
aq add_machine --machine testhw --model spyserver --rack forlexluthor
```

### Network interfaces

Each machine has a number of network interfaces, with their MAC
addresses.  They need to be added to the machine object previously created. Aquilon
supports different types of interfaces (public, management, vlan...): see `aq help add_interface`
for details. The MAC address can be explicitly defined for a standard machine or autogenerated
for a virtual machine. The interface can belong to a port group. One of the interface must be
marked as `bootable` to be able to define an IP address when adding the host.

In our example, we'll use a standard public interface and mark it as bootable.

```bash
aq add_interface --interface eth0 --machine 'testhw' --mac 'AA:BB:CC:DD:EE:FF'
aq update_interface -interface eth0 --machine 'testhw' --bootable
```

## Declaring networks

Once we have the hardware in place, it's time to declare the networks
our hosts live in.

We'll use the `add_network` command:

```bash
aq add_network --network 'leaks' --ip '192.168.1.0' --netmask '255.255.255.0' --city 'metropolis'
aq add_network --network 'reporters' --ip '192.168.100.0' --netmask '255.255.255.0' --city 'metropolis'
```

And now the broker knows about two networks, each with its own
separate gateways.  Networks can live in different network
environments (for instance, internal, public...) on which separate policies may
apply.  Check the help for the `aq add_network_environment` command.

### DNS domains

Our network has some DNS domains.  We have to add them:

```bash
aq add_dns_domain --dns_domain 'dailyplanet.com'
```

## Configuring the Template Library

The template library is a set of generic templates that
help to build host descriptions. It provides many building blocks, in particular
`features`, ready to use to configure standard OS services and a few more specific
middleware, like [OpenStack](https://www.openstack.org) for clouds or
[UMD](https://wiki.egi.eu/wiki/Middleware){:data-proofer-ignore=""}
for grid.

### Importing the Template Library

The template library must be imported in the [plenary template][aquilon_plenary] area using the
[plenary_template_library.py](https://github.com/quattor/release/tree/master/src/scripts/plenary_template_library)
script. Download the script and execute it with option `--help` to display all the options available. A typical execution of this
script, to download the template library version `18.3.0`, is:

```bash
plenary_template_library.py --release 18.3.0 /var/quattor/cfg/plenary/template-library
```

The `/var/quattor/cfg/plenary/template-library` directory will contain a directory corresponding to the version
downloaded, making easy to have different versions of the template library. In this directory, a sub-directory
is created for each component of the template library: `core`, `os`, `standard`, `openstack` and `grid`. As the
template library is not supposed to be modified, it is intentionally placed into the plenary templates
directory rather than in the `template-king` Git repository.

### Enabling the Template Library

A template library version is enabled in the context of an archetype, using `archetype/base.pan`
This template is typically placed in the archetype directory for which you want to enable this version
of the template library. Currently, we'll add it to the plenary templates area, under
 `/var/quattor/cfg/plenary/web_servers`. The content to add to this template is:

```pan
unique template archetype/base;

# Replace by the template library version you want to use
final variable QUATTOR_RELEASE = '18.3.0';

# Replace by the OS version you want to use
final variable OS_RELEASE = 'el7.x-x86_64';

variable LOADPATH = append(SELF, format('template-library/%s/core', QUATTOR_RELEASE));
variable LOADPATH = append(SELF, format('template-library/%s/standard', QUATTOR_RELEASE));
variable LOADPATH = append(SELF, format('template-library/%s/os/%s', QUATTOR_RELEASE, OS_RELEASE));

# If you want to use UMD grid middleware templates, uncomment the following lines
#final variable GRID_MIDDLEWARE_RELEASE = 'umd-4';
#variable LOADPATH = append(SELF, format('template-library/%s/grid/%s', QUATTOR_RELEASE, GRID_MIDDLEWARE_RELEASE));

# If you want to use OpenStack templates, uncomment the following lines
#final variable OPENSTACK_RELEASE = 'newton';
#variable LOADPATH = append(SELF, format('template-library/%s/openstack/%s', QUATTOR_RELEASE, OPENSTACK_RELEASE));
```


## Declaring your first host

### Adding a personality

Before being able to add a host, we need to define a `personality`.
Personalities are collections of smaller chunks called features.  A
`feature` is re-usable in many contexts, by different personalities,
hardware models...

At this stage we'll create an empty personality, without associated features. Indeed, a feature
definition implies writing some pan templates, something that cannot be done at this stage.

Before creating the personnality, we need to define a GRN. A GRN is an organisation group or
entity name that will own features and personalities. You can create as
many GRNs as you want. Each GRN has a name and a unique ID, called an `EON_ID`.
They are respectively specified with option `--grn` and `--eon_id` in `aq` commands that need them: both
are equivalent. To create our first GRN, use the following command:

    ```bash
    aq add_grn --grn test --eon_id 1
    ```

When creating a personality, here `test`, it must be attached to an already existing archetype (here
`web_servers`):

    ```bash
    aq add_personality --personality test --archetype web_servers \
                       --grn test --host_environment dev
    ```

### Adding the operating system

Aquilon must also know about the valid OS for each archetype (you can declare several). An
OS has a name and a version.

To create an OS object for CentOS 7.x for the archetype `web_servers`, use the following command:

    ```bash
    aq add_os --osname centos --osversion 7.x --archetype web_servers
    ```

Once the OS object has been created, it is necessary to create a template associated with it.
Currently, we'll create it in the plenaray template area, `/var/quattor/cfg/plenary`. The template
must be called `config.pan`, under the directory `web_servers/os/centos/7.x` (archetype, osname, osversion).
At this stage we'll create an empty template:

```pan
unique template os/centos/centos/7.x;
```

### Creating Hardware-related templates

Every model object must have a matching template that must be created manually. Currently, we'll create them
in the plenaray template area, `/var/quattor/cfg/plenary`, under the `hardware` directory. You must create one
template for the machine model and for each its components (cpu, ram, nic, harddisk). The template can be empty.

If you used the suggested
model names, use the following commands to create these templates:

```bash
cd /var/quattor/cfg/plenary
for template in hardware/machine/luthorindustries/spyserver \
                hardware/ram/generic \
                hardware/cpu/intel/mygreatcpu \
                hardware/harddisk/generic \
                hardware/harddisk/generic
do
    template_ns=$(dirname ${template})
    template_file=${template}.pan
    echo "Creating structure template ${template_file}..."
    mkdir -p ${template_ns}
    echo "structure template ${template};" > ${template_file}
done
```


### Adding and Building the First Host

Now we can declare a host on our `testhw` machine.
A host needs to receive a personality when it is
first registered in Aquilon, that can be later changed if necessary.

Now, we use all that information to add a `testsrv.dailyplanet.com` host:

```bash
aq add_host --hostname testsrv.dailyplanet.com --machine testhw --ip 192.168.1.3 \
             --domain test --archetype web_servers --personality test --osname centos --osversion 7.x
```

Once the host has been added to the Aquilon database, it is possible to build its configuration.
This step involves generating the plenary templates describing the host configuration (machine used,
OS, personality...) and compiling those templates. This is done with the command `aq reconfigure`:

```bash
aq reconfigure --hostname testsrv.dailyplanet.com
```

The execution of `aq reconfigure` will build the host profile in `/var/quattor/cfg/domains/test/profiles`
and compile it. The compilation should succeed: if it fails, review the previous steps. Failure to compile
a profile causes it to be removed from the `profiles` directory.

## Troubleshooting

### Error "branch already exists" when creating a domain

This may happen when using the command `aq add_domain` if a previous execution of the same domain failed after
the corresponding Git branch in `template-king` repository has been created. Once the problem that caused the
command to fail has been fixed, to be able to create the domain it is necessary to first delete this branch.

To do so, go to the `template-king` repository and delete the branch with the following commands

```bash
# Replace the directory by your actual path, if different from the default configuration
cd /var/quattor/template-king
# Replace 'domain' by the actual domain name that you are trying to create
git branch -D domain
```

### Failure to run aq compile

If `aq compile` fails to run properly (not if the compilation results in errors) because of something wrong
with the compilation command, look for string `ant` in `/var/quattor/logs/aqd.log` and execute the command found
in the log as the user who run the `aq compile` command, adding the option `--execdebug`, after defining
the `ANT_HOME` environment variable with the value of the `ant_home` parameter in `/etc/aqd.conf`.

This allows to see
the Java command executed with all its options and to identify the wrong one.

In particular if you get the error `Could not find or load main class org.apache.tools.ant.launch.Launcher`
and if `ant` has been installed, you should suspect an incorrect definition of `ant_home` parameter in
`/etc/aqd.conf`. The standard value should be `/usr/share/ant` and result in `/usr/share/ant/lib/ant-launcher.jar`
being added to the classpath.
