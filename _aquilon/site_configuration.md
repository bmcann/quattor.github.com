---
layout: article
title: Starting a Site with Aquilon
author: Luis Fernando Muñoz Mejías
menu: Using Aquilon
redirect_from: /documentation/2013/10/25/aquilon-site.html
---

{% include link_definitions.md %}

This page documents how to configure a site with Aquilon, once the Aquilon broker is running,
i.e. how to describe the hardware present in the site and how to configure hosts and services.
For Aquilon installation, refer to the [dedicate page][aquilon_install]

This document explains the steps required to set up the clusters
for the Daily Planet, Superman's employer. Feel free to replace the names used here by those
relevant to your organization but be sure to remain consistant.

*Note: this documentation assumes that you have an `aq` command available in your
path. If this is not the case, define an `aq` alias to `/opt/aquilon/bin/aq.py`.*


## Aquilon terminology

These are the basic terms in Aquilon operations:

* `archetype`: The highest possible grouping of hosts into distinctly
    seperate types. Archetypes are a bundle
    that expresses how to build something. It defines what set of
    templates to use (for example, what operating systems are
    available, etc). One typical archetype is `linux` for all the Linux-based
    hosts. Hosts therefore require an archetype to define
    how they are compiled.
* `broker`: The backend which the aq client communicates with and the
    owner of all object and production templates.  We'll refer to it
    also as `aqd`.
* `cluster`: A group of hosts related in some way, different to an
    archetype in that hosts may or may not be in a cluster. When
    grouping hosts into a cluster, an object profile is also built for
    the cluster, as well as the hosts. Clusters go through a
    completely different schema and build process to how hosts are
    built and therefore have a different archetypes.
* `domain`: A set of shared Quattor templates. Entities to be
  configured live in exactly one domain. A domain is currently
  implemented as a branch in the template-king git repository.
* `feature`: A re-useable configuration template that configures a
  specific thing but does not in itself describe a complete
  system. A feature may be included in
  a personality or anywhere else that PAN template code can be
  included.
* `personality`: describes the
  services required but not the instance (selected using plenary
  template information) specific configuration (hardware used, OS version...).
* `plenary`: Template generated by the broker, on the fly, from an
  external source such as a database.
* `sandbox`: A development area for making changes to Pan
  templates. Each sandbox must be started from a domain and hosts or
  clusters may be managed into the sandbox to allow for pre-deployment
  testing. Once the template code is fully tested, it must be
  published back to the broker and then deployhttp://quattor-pan.readthedocs.org/en/latested to the shared domain.
* `service`: A network-based service with well-known clients and
  servers such as DNS, DHCP, NTP, etc. Each service can have multiple
  instances. Service instances must be mapped which allows the
  administrator to model client hosts connecting to different
  instances based on location and optionally personality.

### Before proceeding

Some understanding of Quattor's [architecture](/documentation/2012/06/19/documentation-overview.html) and the
[Pan language][pan_language] are expected before reading this document.

We'll interact with the broker using the `aq` command, which has lots
of sub-commands.  Each sub-command has a detailed help.

In this stage we will be adding a site, so we will use `add_*`
commands.  Most of the Aquilon commands have a `show_`, `update_`, `search_` and
`del_` counterparts.  `search_` commands are similar to `show_` commands but provide more
options to select the objects to show. You are recommended to read the help of each
command before actually running it.

*Note: most `aq` commands are two words separated by an `_` (e.g. `add_personality`). For all these
commands, it is possible to enter the command as two separate words (e.g. `add personality`).*

Before starting using the `aq` command, you need get a Kerberos ticket. If
the user you are logged on has been declared as a Kerberos principal, you
can do it with `kinit` command (without parameters).

## Archetypes, domains...

You need to start by declaring archetypes and the basic domains for
your Aquilon instance.  Let's imagine we have two archetypes, one for
Linux hosts under Quattor control and another one for IPMI interfaces

```bash
aq add archetype --archetype 'linux' --compilable
aq add archetype --archetype 'ipmi' --nocompilable
```

Next come the domains, which are just Git branches with some metadata.
We'll define a `prod`uction and a `test`ing domains.

```bash
aq show domain --all
# If domain 'prod' already exists, skip its creation
aq add domain --domain 'prod'
aq add domain --domain 'test'
```

## Storing your inventory

The Aquilon database contains the entire inventory of your
infrastructure.  You may use it as your asset management database, or
feed it from your existing one.  You will have to store all your
hardware, its characteristics and locations, which is easy to script
but nevertheless may be an annoying process.

### Geographical locations

Before starting, you have to add the geographical locations of your
infrastructure.  The meanings of the commands to run should be
obvious.  We list here an example:

```bash
aq add organization --organization 'daily_planet'
aq add hub --hub 'pacific' --organization 'daily_planet'
aq add continent --continent 'america' --hub 'pacific'
aq add country --country 'us' --continent 'america'
aq add city --city 'metropolis' --fullname 'Metropolis' --country 'us' --timezone 'dct'
aq add building --building 'hq' --city 'metropolis' --address '355, 1000 Broadway'
aq add room --room 'supersecret' --building 'hq'
```

List your own addresses, rooms...  but remember that each step depends
on the previous ones.  If you want to add European countries, you have
to insert Europe as a continent first! Also note that object names
should not start with a digit and cannot contain spaces.

### Your hardware inventory

Next comes your hardware.  At the very least, your racks, chassis and
servers will be stored here.  It is a good place to store other
hardware such as switches.

For racks, you have to specify on which row and column inside that
row they are, the room they are located into and an optional fullname. A rack ID
will be allocated automatically with a prefix who is the building name and a sequential
number in this building.

```bash
aq add rack --fullname 'forlexluthor' --row 'R' --column 'C' --room 'supersecret'
```

Next come servers, switches, routers... we'll go for servers,
`machine` in Aquilon terms.  To be able to define a server, we need to first define its
vendor and its CPU model. Initial Aquilon database already has several vendors and models
defines: use `aq show vendor --all` and `aq show model --all` to see them.

Here we'll use a simple rackmounted server but Aquilon allows to
also define other types of servers, in particular chassis and blades, and to
use them to build a machine. See `aq help add model`.

```bash
aq add vendor --vendor luthorindustries --comments "Bad guys make good sells"
aq add model --model mygreatcpu --vendor intel --type cpu
aq add model --model spyserver --vendor luthorindustries --type rackmount --cpuname mygreatcpu \
             --cpunum 2 --memory 98304 --disktype local --diskcontroller sas --disksize 1000
aq add machine --machine testhw --model spyserver --rack forlexluthor
```

### Network interfaces

Each machine has a number of network interfaces, with their MAC
addresses.  They need to be added to the machine object previously created. Aquilon
supports different types of interfaces (public, management, vlan...): see `aq help add interface`
for details. The MAC address can be explicitly defined for a standard machine or autogenerated
for a virtual machine. The interface can belong to a port group. One of the interface must be
marked as `bootable` to be able to define an IP address when adding the host.

In our example, we'll use a standard public interface and mark it as bootable.

```bash
aq add interface --interface eth0 --machine 'testhw' --mac 'AA:BB:CC:DD:EE:FF'
aq update interface -interface eth0 --machine 'testhw' --bootable
```

## Declaring networks

Once we have the hardware in place, it's time to declare the networks
our hosts live in.

We'll use the `add_network` command:

```bash
aq add network --network 'leaks' --ip '192.168.1.0' --netmask '255.255.255.0' --city 'metropolis'
aq add network --network 'reporters' --ip '192.168.100.0' --netmask '255.255.255.0' --city 'metropolis'
```

And now the broker knows about two networks, each with its own
separate gateways.  Networks can live in different network
environments (for instance, internal, public...) on which separate policies may
apply.  Check the help for the `aq add network_environment` command.

### How to define the routers for my networks?

When we declare our networks, Aquilon will assume a fixed IP
(typically the first IP in the range) is the gateway in it.  If this
isn't correct, you have to modify the configuration for the broker.
Create a `network_unknown` section, and declare the default gateway offset.

```ini
[network_unknown]
default_gateway_offset=30
reserved_offsets=1,30,25
first_usable_offset=40
```

And finally we restart the broker:

```bash
systemctl restart aquilon-broker
```

If some of your networks don't adhere to this convention, you'll need
to declare their routers in Aquilon.  For instance, let's suppose that
the gateway in `reporters` network has offset 3:

```bash
aq add router --ip '192.168.100.3' --fqdn 'router.reporters.metropolis.com'
```

If your network is an internal one (the default), some restrictions
apply:

* Routers must be part of the `reserved_offsets` list.
* Router offsets must be below the `first_usable_offset`, which the
  broker uses when assigning IP addresses automatically.

If you need an external network, you have to create it with
`--network_environment external` in its command line.

### DNS domains

Our network has some DNS domains.  We have to add them:

```bash
aq add dns_domain --dns_domain 'dailyplanet.com'
```

## Personalities and features

Before being able to add our first host, we need to define a `personality`.
Personalities are collections of smaller chunks called features.  A
`feature` is re-usable in many contexts, by different personalities,
hardware models.

### Creating a GRN

A GRN is an organisation group or entity name that will own features and personalities. You can create as
many GRNs as you want. Each GRN has a neme, specified and a unique ID, called an `EON_ID`.
They are respectively specified with option `--grn` and `--eon_id` in `aq` commands that need them: both
are equivalent.

To create a GRN, use the following command:

    ```bash
    aq add grn --grn test --eon_id 1
    ```

### Adding features

We can now create features: This involves creating the personality in the Aquilon database with the
`aq` command and adding a pan template defining the feature in the template master Git repository for the
domain (here `test`), located under `/var/quattor/domains`.

In this example we'll create two templates

```bash
aq add feature --feature demo --type host --activation dispatch --deactivation reboot --grn test
aq add feature --feature rootpasswd --type host --activation dispatch --deactivation dispatch --grn test
```

For each template, create a template `config.pan` in the template master directory, in our example
`/var/quattor/domains/test` (where `test` is the domain the host will belong to). This template must
reside at the path `archetype/features/feature_name`, with `archetype` the archetype the feature will belong to
(in our example `linux`) and `feature_name` equal to `demo` for the first feature and to `rootpasswd` for the second
one. At this stage create aach file with the following content (`feature_name` being replaced by the appropriate
value):

```
unique template features/feature_name/config;
```

Once the templates associated with the features have been created, it is necessary to commit them and push them
to the `template-king` Git repository which is defined as the origin of the template master repository for the
domain, `test` here:

```bash
cd /var/quattor/domains/test
git add .
git commit -m 'Add features demon and rootpasswd'
git push
```


### Adding a personality

Steps involved a personality creation are:

* Creation of the personality, here `test`, attached to an already existing archetype:

    ```bash
    aq add personality --personality test --archetype linux \
                       --grn test --host_environment dev
    ```

* Bind the features to the personality or to the archetype, if you want them to apply it to every
personality in the archetype, like for `rootpasswd`:

    ```bash
    aq bind feature --feature demo --personality test --archetype linux
    aq bind feature --feature rootpasswd --archetype linux
    ```

* Promote the personality as a current: Aquilon implements personality staging so that a modification to a
personality does not affect the hosts using it until it is declared `current`. After its creation or a modification,
the stage is set to `next`.

    ```bash
    # This command should show that the personality 'test' stage is 'next'
    aq show personality --all
    aq promote --personality test --archetype linux
    # This command should show that the personality 'test' stage is now 'current'
    aq show personality --all
    ```

## Declaring your first host

### Adding the operating system

Aquilon must know about the valid OS for each archetype (you can declare several). An
OS has a name and a version.

To create an OS object for CentOS 7.x for the archetype `linux`, use the following command:

    ```bash
    aq add os --osname centos --osversion 7.x --archetype linux
    ```


### Adding a host

Now we can declare a host on our `testhw` machine.
A host needs to receive a personality when it is
first registered in Aquilon, that can be later changed if necessary.

Now, we use all that information to add a `testsrv.dailyplanet.com` host:

```bash
aq add host --hostname 'testsrv.dailyplanet.com' --machine 'testhw' --ip '192.168.1.3' \
             --domain test --archetype linux --personality test --osname centos --osversion 7.x
```

Congratulations!  You have your first host!  Run `aq show_host --all`
to see it.

But we aren't done yet.  This host is empty!!  And Aquilon won't even
compile it.  Now it's time to produce Pan code to configure the host.

## Creating your first sandbox

We'll do all our work in sandboxes, and we'll dispose of them when
their purpose is ready.   So, let's create our first sandbox:

```bash
aq add sandbox --sandbox site-init
```

We'll also associate one host to it:

```bash
aq manage --sandbox $USER/site-init --hostname 'testsrv.dailyplanet.com'
```

And you can now cd to the `templatesdir` (in our case,
`/var/lib/templates/$USER/site-init`) and start producing code there.

## Importing your first templates

It's now time for some Pan code!  Let's start by setting up the
archetype.  We'll create a directory for the `linux` archetype, and
put two Pan templates there: `base` and `final`.



## Compiling the first host

## Deploying the first configuration

## Troubleshooting

### Error "branch already exists" when creating a domain

This may happen when using the command `aq add domain` if a previous execution of the same domain failed after
the corresponding Git branch in `template-king` repository has been created. Once the problem that caused the
command to fail has been fixed, to be able to create the domain it is necessary to first delete this branch.

To do so, go to the `template-king` repository and delete the branch with the following commands

```bash
# Replace the directory by your actual path, if different from the default configuration
cd /var/quattor/template-king
# Replace 'domain' by the actual domain name that you are trying to create
git branch -D domain
```
